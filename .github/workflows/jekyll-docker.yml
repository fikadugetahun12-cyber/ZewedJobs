name: PWA CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests (if any)
      run: npm test || echo "No tests configured"
    
    - name: Run ESLint
      run: npm run lint || echo "No linting configured"
    
    - name: Check PWA requirements
      run: |
        # Check essential files exist
        [ -f "service-worker.js" ] || echo "‚ùå Missing service-worker.js"
        [ -f "manifest.json" ] || echo "‚ùå Missing manifest.json"
        [ -f "offline.html" ] || echo "‚ùå Missing offline.html"
        [ -f "server.js" ] || echo "‚ùå Missing server.js"
        
        # Check manifest validity
        if [ -f "manifest.json" ]; then
          echo "‚úÖ Manifest exists"
          # Basic validation
          if grep -q '"name"' manifest.json && grep -q '"icons"' manifest.json; then
            echo "‚úÖ Manifest has required fields"
          else
            echo "‚ùå Manifest missing required fields"
          fi
        fi

  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build PWA assets
      run: |
        # Generate icons if script exists
        if [ -f "scripts/generate-icons.js" ]; then
          node scripts/generate-icons.js
        fi
        
        # Create build directory
        mkdir -p dist
        
        # Copy essential files
        cp service-worker.js dist/
        cp manifest.json dist/
        cp offline.html dist/
        cp server.js dist/
        cp package.json dist/
        
        # Copy assets
        cp -r assets dist/ || echo "No assets directory"
        
        # Generate production server.js
        cat > dist/server.js << 'EOF'
        const express = require('express');
        const path = require('path');
        const app = express();
        const PORT = process.env.PORT || 3000;
        
        // Production settings
        app.disable('x-powered-by');
        app.use(express.static(path.join(__dirname, './'), {
          maxAge: '1y',
          setHeaders: (res, filePath) => {
            if (filePath.match(/\.(js|css|png|jpg|jpeg|gif|ico|svg)$/)) {
              res.setHeader('Cache-Control', 'public, max-age=31536000');
            }
          }
        }));
        
        // Service worker special handling
        app.get('/service-worker.js', (req, res) => {
          res.setHeader('Content-Type', 'application/javascript');
          res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
          res.setHeader('Service-Worker-Allowed', '/');
          res.sendFile(path.join(__dirname, 'service-worker.js'));
        });
        
        app.get('/manifest.json', (req, res) => {
          res.setHeader('Content-Type', 'application/manifest+json');
          res.sendFile(path.join(__dirname, 'manifest.json'));
        });
        
        // Main route
        app.get('/', (req, res) => {
          res.sendFile(path.join(__dirname, 'index.html'));
        });
        
        // API routes (if any from original server.js)
        app.get('/api/status', (req, res) => {
          res.json({ status: 'online', version: process.env.npm_package_version || '1.0.0' });
        });
        
        // 404 handler
        app.use((req, res) => {
          res.status(404).sendFile(path.join(__dirname, 'offline.html'));
        });
        
        app.listen(PORT, () => {
          console.log(`üöÄ PWA running on port ${PORT}`);
        });
        EOF
        
        # Create index.html for production
        if [ ! -f "index.html" ]; then
          cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>My PWA</title>
            <link rel="manifest" href="/manifest.json">
            <meta name="theme-color" content="#667eea">
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 0; 
                    padding: 20px; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    min-height: 100vh;
                }
                .container { max-width: 800px; margin: 0 auto; }
                h1 { text-align: center; }
                .status { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ PWA Successfully Deployed!</h1>
                <div class="status">
                    <p>‚úÖ Service Worker: <span id="swStatus">Checking...</span></p>
                    <p>üåê Network: <span id="networkStatus">Checking...</span></p>
                    <button onclick="installPWA()" id="installBtn" style="display:none;">
                        üì± Install App
                    </button>
                </div>
            </div>
            
            <script>
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(() => document.getElementById('swStatus').textContent = '‚úÖ Registered')
                        .catch(() => document.getElementById('swStatus').textContent = '‚ùå Failed');
                }
                
                document.getElementById('networkStatus').textContent = 
                    navigator.onLine ? '‚úÖ Online' : '‚ùå Offline';
                
                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('installBtn').style.display = 'block';
                });
                
                function installPWA() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                    }
                }
            </script>
        </body>
        </html>
        EOF
        else
          cp index.html dist/
        fi
        
        echo "‚úÖ Build completed"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pwa-dist
        path: dist/
        retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only deploy from main branch
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.deployment_url }}
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: pwa-dist
    
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: .  # Deploy the downloaded dist folder
        branch: gh-pages
        clean: true
    
    - name: Deploy to Vercel
      if: env.VERCEL_TOKEN != ''
      run: |
        npm install -g vercel
        vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --yes
    
    - name: Create Deployment Status
      id: deploy
      run: |
        echo "deployment_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
    
    - name: Notify Deployment
      run: |
        echo "‚úÖ PWA deployed successfully!"
        echo "üåê Live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

  lighthouse:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        uploadArtifacts: true
        temporaryPublicStorage: true
        configPath: './lighthouserc.json'  # Optional config file
    
    - name: Upload Lighthouse Report
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: .lighthouseci/
        retention-days: 30
